ods rtf file = "Josh_Liu_Final.rtf" ;
options nodate nonumber;
OPTIONS NODATE NONUMBER;
TITLE1; TITLE2;
ods noproctitle;


data cars;
	set sashelp.cars;
	if cylinders in (3,5,10,12) then delete;
	profit = MSRP - Invoice;
	logprofit = log(profit); logMSRP = log(MSRP); logInvoice = log(Invoice); 
		logEngineSize = log(enginesize); logCylinders = log(cylinders);
		logHorsePower = log(Horsepower); logMPG_City = log(MPG_City); logMPG_Highway = log(MPG_Highway);
		logWeight = log(Weight); logWheelbase = log(Wheelbase); loglength = log(length); EngineSizeJittered = EngineSize + .01 * (RAND('UNIFORM') - .5);
	if origin = "USA" then DorF = "Domestic"; else DorF = "Foreign"; 
run;


/*
proc contents data = cars; run;
proc print data = cars (firstobs = 1 obs = 10);run;
*/

/*Introduction*/
ods text = "This report is prepared by Josh, contracted by client Illini Auto.";
ods text = "Introduction";
ods text = "This data analysis report is based on the car inventory in 2005, on all models of cars in the inventory with an engine of 4, 6, 8 cylinders.";
ods text = "This report is compiled based on the dataset provided by the client. The dataset has 415 observations, each observation being a model of vehicles in the inventory of the client. Variables include Make, Model, MSRP, Invoice Price, Engize size, number of cylinders, horsepower, weight, length, and wheelbase length.";
ods text = "The purpose of this analysis is to identify underlying patterns between profitability and technical parameters of automobiles in inventory, in order to facilitate more informed decision-making in the operation of the dealership.";
ods text = "As requested by the client, this data analysis report will cover the following topics: 1. descriptive statistics of characteristics of cars from the previous year; 2. Analysis of effect of techinical parameters on profitability ; 3. Statistical modeling of profitability and interpretation; 4. Analysis of origins of cars: domestic or imports; 5. Classification of cars based on the number of cylinders; 6. Appendix: diagnostics of statistic models.";


/* Part 1: Introduction*/
ods text = "Part 1: Descriptive Statistics";
ods text = "This table shows the top 20 makes that has the most models on sale in the dealership:";

proc freq data = cars noprint;
	tables make / out = freqMake;
	title "Top 20 Makes with Most Models";
run;

proc sort data = freqMake out = freqMake;
	by descending Count ;
run;

title "Number of Models by Make, top 20 Makes";

proc print data = freqMake (firstobs = 1 obs = 20);
run;
title;


proc gchart data = cars;
	pie type / percent = outside;

run;
title;

proc gchart data = cars;
	pie origin / percent = outside;
run;

proc gchart data = cars;
	pie DriveTrain / percent = outside;
run;

title "Distribution of MSRP";
proc univariate data = cars;
	var msrp;
	histogram msrp;
	ods select BasicMeasures histogram;
run;
ods text = "Most models on sale have MSRP between $15,000 and $45,000, with a few models having MSRP far outlying, as high as $195,000.";
title;


proc gchart data = cars;
	hbar enginesize / nostats ;
run;

title;


proc gchart data = cars;
	pie cylinders /percent = outside;

run;


proc univariate data = cars;
	var mpg_highway;
	histogram mpg_highway ;
	ods select BasicMeasures histogram;
run;
ods text = "Highway MPG is pretty nicely distributed, with most models having MPG between 21 and 33. ";
title;

proc univariate data = cars;
	var horsepower;
	histogram horsepower;
	ods select BasicMeasures histogram;
run;
ods text = "Horsepower of most models falls between 140 and 300. There are a few models with horse power less than 140 and higher than 380, which are considered to be outliers.";

proc univariate data = cars;
	var weight;
	histogram weight;
	ods select BasicMeasures histogram;
run;

proc univariate data = cars;
	var profit;
	histogram profit;
	ods select BasicMeasures histogram;
run;
ods text = "Most models on sale have expected profit between $750 and $6,750, with one model having expected profit far outlying, as high as $18,750.";
title;

/* Part 2: Compare Expected Profit by Group*/
ods text = "Part 2: Compare Expected Profit by Group defined by vehicle-related technical parameters";
ods text = "In this part, I will group all vehicles into tree groups based on Engine size, horse power, fuel efficienty, and vehicle size measures.";
ods text = "And then, I will perform a series of analyses to see if there is any difference of profit generated by the three groups of vehicles.";


proc cluster data = cars outtree = cluster_out method = average print = 15  ccc pseudo noprint;
	var  EngineSize Horsepower MPG_City MPG_Highway  Weight Length Wheelbase;
	copy make model profit  EngineSize Horsepower MPG_City MPG_Highway  Weight Length Wheelbase;
*	ods select ClusterHistory Dendrogram ccc pseudo;
run;

proc tree data = cluster_out noprint ncl = 5 out = tree_out noprint;
	copy make model profit  EngineSize Horsepower MPG_City MPG_Highway  Weight Length Wheelbase;
run;

data tree_out;
	set tree_out
	where cluster ne 5;
	if cluster = 4 then cluster = 3;
run;
proc tabulate data = tree_out;
	class cluster;
	tables cluster;
run;

proc glm data = tree_out plots = diagnostics;
	class cluster;
	model profit = cluster;
	ods select BoxPlot;
run;
ods text = "This plot shows the distribution of profit by group. We can see clearly that Group 3's vehicles have larger profit than Group 1, and Group 1's vehicles have larger profit than Group 2.";

ods text = "Further analysis demonstrates a high correlation between profit and vehicle power and size parameters. See the following boxplots for more details.";

proc glm data = tree_out;
	class ProfitGroup;
	model profit = ProfitGroup;
	ods select boxplot;
	title "Profit By Group";
run;

proc glm data = tree_out;
	class ProfitGroup;
	model EngineSize = ProfitGroup;
	ods select boxplot;
	title "EngineSize By Group";
run;


proc glm data = tree_out;
	class ProfitGroup;
	model Horsepower = ProfitGroup;
	ods select boxplot;
	title "Horsepower By Group";
run;

proc glm data = tree_out;
	class ProfitGroup;
	model MPG_City = ProfitGroup;
	ods select boxplot;
	title "City MPG By Group";
run;


proc glm data = tree_out;
	class ProfitGroup;
	model MPG_Highway = ProfitGroup;
	ods select boxplot;
	title "Highway MPG By Group";
run;


proc glm data = tree_out;
	class ProfitGroup;
	model Weight = ProfitGroup;
	ods select boxplot;
	title "Vehicle Weight By Group";
run;


proc glm data = tree_out;
	class ProfitGroup;
	model Length = ProfitGroup;
	ods select boxplot;
	title "Vehicle Length By Group";
run;


proc glm data = tree_out;
	class ProfitGroup;
	model Wheelbase = ProfitGroup;
	ods select boxplot;
	title "Vehicle Wheelbase By Group";
run;

ods text = "The boxplots above show larger vehicle, more powerful vehicle, vehicles that burn more gas bring in more profit.";
ods text = "Without consideration of impact on the environment, the dealer is advised to sell more vehicles that come with a large-volume engine, with an engine of more cylinders, that burns a lot of gas per unit of distance traveled, vehicles of large length, and vehicles of heavy weight.";
ods text = "Rebalancing inventory towards more larger vehicles is a strategy that can increase expected profit for the dealer.";


/* Part 3: Statistical Model Construction to Predict Expected Profit*/
ods text = "Part 3: Statistical Model Construction to Predict Expected Profit";
ods text = "In this part, I will develop a statistical model with Expected Profit as response variable. This part gives final result of the model. Intermediary process and diagnostics procedures are described in the appendix at the end of the report.";



proc reg data = cars noprint;
	model logprofit = MSRP  Weight Horsepower;
	output out = regresult residual = residual;
run;

data regresult;
	set regresult;
	residualabs = abs(residual);
run;


*It turns out the 9 outlying residuals are from Suzuki vehicles and a Porsche. I will remove these 9 vehicles from analysis.;

proc reg data = regresult;
	where residualabs < 1;
	model logprofit = MSRP Weight Horsepower;
run;

*Residual plots show no strong indication of violation of equal variance assumption. q-q plot also shows no strong indication of violation of normality assumption. There is one observation, however, with exceptionally large Cook's DIstance. I will try to remove this point from our model.;

proc reg data = regresult noprint;
	where residualabs < 1;
	model logprofit = MSRP Weight Horsepower;
	output out = regresult_cookd cookd = cookd;
run;


proc reg data = regresult_cookd;
	where cookd < .1;
	model logprofit = MSRP Weight Horsepower;
	output out = regresult_cookd cookd = cookd;
	ods select diagnosticspanel;
run;
	
proc reg data = regresult_cookd;
	where cookd2 < .1;
	model logprofit = MSRP Weight Horsepower;	
	output out = regresult_cookd cookd = cookd;
	ods select diagnosticspanel;
run;

proc reg data = regresult_cookd;
	where cookd3 < .1;
	model logprofit = MSRP Weight Horsepower;	
	output out = regresult_cookd cookd = cookd;
	ods select diagnosticspanel;
run;

proc reg data = regresult_cookd;
	where cookd4 < .1;
	model logprofit = MSRP Weight Horsepower;	
	ods select ANOVA FitStatistics ParameterEstimates;
run; * This is the final model;

ods text = "To analyze what variables affect expected profit the most, I developed a linear regression model and attempted to isolate three variables that have a strong bearing on expected profit.";
ods text = "During the analysis process, it happens that all Suzuki models, of which there are a total of 8, could not be accommodated in the final model. Therefore, analysis on expected profit is only conducted on non-Suzuki models. Suzuki vehicles will be analyzed in a separate part.";
ods text = "Three variables were identified as the most influential on the expected profit: MSRP, Weight, and Horsepower.";
* Given the relative large magnitude of the variable, interpretation of the model is scaled up;
ods text = "The model shows, holding all other variable constants, with MSRP increasing by $1,000, expected profit increases by 2.65%;";
ods text = "With Weight increasing by 100 lbs, expected profit increases by 1.50%;";
ods text = "With Horsepower increasing by 10, expected profit increases by 1.38%";
ods text = "Based on the statistical model, it is suggested that vehicles with a higher MSRP, a heavier Weight, and a stronger horsepower is expected to generate a larger profit.";

ods text = "Note that we excluded Suzuki from linear regression. Now I am going to compare profit of cars made by Suzuki, and all other cars.";

data  cars;
	set cars;
	if Make = "Suzuki" then Suzuki = 1;
	else Suzuki = 0;
run;

proc glm data = cars;
	class Suzuki;
	model profit = Suzuki;
	ods select Boxplot;
	title "Expected Profit: Suzuki or All Others";
run;
title;


ods text = "Result shows that Suzuki cars have significanly less expected profit than other cars.";

/* Part 4: Determination, based on other variables, whether a model of vehicle is domestic or an import (Logistic Regression)*/
ods text = "Part 4: Determination, based on other variables, whether a model of vehicle is domestic or an import";
ods text = "In this part, I will develop a logistic regression model, and identify which factors are associated with the odd of a certain vehicle being domestic. I will also try to predict whether a certain model of vehicle is domestic or an import.";
ods text = "To conduct such an analysis, I re-coded the variable Origin into 'Domestic' if its value is 'USA', and 'Foreign' if otherwise.";

*Note that probability modeled is Domestic;


proc logistic data = cars;
	model DorF =  EngineSize Cylinders Horsepower MPG_Highway  MPG_City Weight Wheelbase ;
	ods select ResponseProfile OddsRatios ParameterEstimates ;
run;
ods text = "This model shows that the odd of a car being domestic is associated with the following contributing factors: bigger engine size, better MPG on high way, and longer wheelbase.";
ods text = "With 0.1 additional unit increase in Engine Size, the odd of a vehicle being domestic is expected to increase by 44.78% (40.462 ^ 0.1 -1).";
ods text = "With one additional unit increase in highway MPG, the odd of a vehicle being domestic is expected to increase by 29.8%.";
ods text = "With one additional unit increase in wheelbase, the odd of a vehicle being domestic is expected to increase by 10.8%.";

ods text = "This model also shows that the odd of a car being domestic is associated with the following undermining factors: less cylinders, less horsepower, lower MPG in the city, and lighter weight.";
ods text = "With one more cylinder, the odd of a vehicle being domestic is expected to decrease by 46.9%.";
ods text = "With one additional unit increase in horsepower, the odd of a vehicle being domestic is expected to decrease by 3.8%.";
ods text = "With one additional unit increase in city MPG, the odd of a vehicle being domestic is expected to decrease by 25.6%.";
ods text = "With 100lbs increase in weight, the odd of a vehicle being domestic is expected to increase by 9.5%.";





 
/* Part 5: Determination, based on other variables, on the number of cylinders a vehicle has (cluster analysis)*/ 



ods text = "Part 5: Determination, based on other variables, on the number of cylinders a vehicle has";


proc stepdisc data = cars sle = .05 sls = .05;
	class cylinders;
	var MSRP Invoice Enginesize Horsepower MPG_City MPG_Highway Length Weight Wheelbase ;
	ods select Summary;
run;



ods text = "Discriminant analysis shows that the vehicles of different numbers of cylinders can be efficiently classified using variables MPG_City, MPG_Highway, Invoice, and Enginesize.";
ods text = "The result shows that we can classify vehicles with different numbers of cylinders, with a high probability of success, based on City MPG, Highway MPG, Invoice Price, and Enginesize.";

/* Conclusion */

ods text = "Part 6: Conclusion";
ods text = "In this report, I conducted analysis on variables regarding pricing of vehicles, as well as physical characteristics of vehicles. ";
ods text = "It was discovered that vehicles can be grouped into three classes: Lower expected profit, middle expected profit, and higher expected profit.";
ods text = "It was found there is a strong association betweeen a vehicle's size and horsepower, and a vehicle's expected profit.";
ods text = "A vehicle that is more powerful, that has a larger engine volume, that has larger physical dimensions, and that burns more gas, brings in a larger expected profit.";
ods text = "Without considering environment impact or 'Global Warming', Illini Auto is advised to expand their business on large vehicles, in order to generate more profit.";


ods text = "Statistical modeling also found linear correlation between expected profit and the following variables: MSRP, Weight, and Horsepower.";

ods text = "This confirms the suggestion derived from the previous model, that a bigger/heavier car is expected to generate more profit for Illini Auto.";

ods text = "In this report, I also conducted analysis on important factors that could help us classify a car's origin: domestic or import.";

ods text = "It was found that Engine Size, Highway MPG and Wheelbase are positive contributors to a car of being likely to be domestic.";

ods text = "In addition, Horsepower, City MPG and Weight are positive contributors to a car of being likely to be an import.";

ods text = "Illini Auto also asked for an analysis that could classify vehicles based on its cylinder number.";

ods text = "It was identified that City MPG, Highway MPG, Invoice, and Engine Size are effectively predictors of vehicles with different numbers of cylinders.";


/*/* APPENDIX */ */

/* Part 2: Compare Expected Profit by Group*/;
ods text = "Part 2: Compare Expected Profit by Group defined by vehicle-related technical parameters";
ods text = "In this part, I aim to compare expected profit by groups of vehicles as defined by technical parameters.";
ods text = "First, I will perform cluster analysis based on engine size and power, fuel efficiency, and vehicle size measures. I will classify vehicles into different groups;";
ods text = "Second, I will compare expected profit by such groups.";

proc cluster data = cars outtree = cluster_out method = average print = 15  ccc pseudo;
	var  EngineSize Horsepower MPG_City MPG_Highway  Weight Length Wheelbase;
	copy make model profit  EngineSize Horsepower MPG_City MPG_Highway  Weight Length Wheelbase;
*	ods select ClusterHistory Dendrogram ccc pseudo;
run;

ods text = "CCC plot, Pseudo F and Pseudo T-squared plot all show 5 cluster is the optimal. Therefore, I will tentatively group all vehicles into 5 groups, subject to double-checking on group size.";

proc tree data = cluster_out noprint ncl = 5 out = tree_out noprint;
	copy make model profit  EngineSize Horsepower MPG_City MPG_Highway  Weight Length Wheelbase;
run;


proc tabulate data = tree_out;
	class cluster;
	tables cluster;
run;

ods text = "There are too few vehicles in Cluster 5. THerefore, I'll remove those 2 vehicles form analysis.";

data tree_out;
	set tree_out;
	where cluster ne 5;
run;
proc tabulate data = tree_out;
	class cluster;
	tables cluster;
run;
ods text = "Now that 4 groups are set up, the dataset is ready for some analysis.";
ods text = "Note that there are different numbers of vechicles in each group. Thus it is an unbalanced case of comparison of means.";

proc glm data = tree_out plots = diagnostics;
	class cluster;
	model profit = cluster;
	lsmeans cluster / pdiff = all cl;
	ods select ModelANOVA OverallANOVA  Boxplot LSMeanDIFFcl FitStatistics;
run;

ods text = "Analysis result shows our model explains 22.54% of the variation in Profit. The model tells us Group 3- and Group 4-vehicles have significantly higher expected profit than Group 1 vehicles, and Group 1 vecicles have significantly higher profit than Group 2 vehicles. There is no significantly difference in expected profit between Group 3 and Group 4.";
ods text = "Given the result, I will combine Group 3 and Group 4, and compare profit again.";

data tree_out;
	set tree_out;
	if cluster = 4 then cluster = 3;
run;

proc tabulate data = tree_out;
	class cluster;
	tables cluster;
run;


proc glm data = tree_out plots = diagnostics;
	class cluster;
	model profit = cluster;
	lsmeans cluster / pdiff = all cl;
	ods select ModelANOVA OverallANOVA  Boxplot LSMeanDIFFcl FitStatistics;
run;

ods text = "Next, I will try to explore what characteristics result in the clustering, as well as the difference in expected profit across the 3 groups.";
ods text = "Principal Component analysis is conducted to check correlation.";
proc princomp data = tree_out;
	var  EngineSize Horsepower MPG_City MPG_Highway  Weight Length Wheelbase;
	
run;
ods text = "Correlation matrix shows clearly that Engine Size, horsepower, and vehicle size measure variables are positively correlated. City MPG and Hightway MPG are positively correlation. Both City MPG and Highway MPG are negatively correlated with each of the variables related to engine size and vehicle size.";
ods text = "This result is consistent with our expectation based on anecdotal experience: larger vehicles and/or more powerful vehicles usually have lower fuel efficiency.";
ods text = "This result is also reflected in the Principal Component 1, which picks out positive values on all variables but City MPG and Highway MPG.";
ods text = "The second Principal Component pickout out positive values on all but Engine Size and Horsepower, which are the only two indicators of vehicle power. All other variables make positive contribution to Principal Component 2.";

proc princomp data = tree_out plots = score (ellipse ncomp = 2);
	var  EngineSize Horsepower MPG_City MPG_Highway  Weight Length Wheelbase;
	ods select ScorePlot;
	id profit;
run;

ods text = "The scoreplot, while difficult to read, seems to indicate vehicles with a larger profit tends to have a larger PC1 value. I begin to suspect larger vehicles / more powerful vehicles generate more profit than other vehicles.";
ods text = "I will have SAS conduct proportional-priors discriminant analysis to confirm my theory.";

proc discrim data = tree_out  pool = test MANOVA crosslisterr;
	class cluster;
	var EngineSize Horsepower MPG_City MPG_Highway Weight Length Wheelbase;
	priors proportional;
	ods select ChiSq Multstat  ClassifiedCrossVal ErrorCrossVal PostCrossVal ;
run;

ods text = "Classification table shows an exceptionally high success rate when classifying vehicles into the correct category. This means my speculation, that vehicle profit is somewhat related to its size and gas-guzzling ability, might be true. However, I will have SAS perform yet another test to further confirm this speculation.";
ods text = "I will conduct Cumulative Logistic distribution.";
ods text = "To conduct cumulative logistic distribution, I will first re-code cluster based on profit. By ascending order of profit, clusters are ordered as Cluster 2, Cluster 1, Cluster 3. Therefore, Cluster 2 is coded into Profit group 1, Cluster 1 are recoded into Profit group 2, and Cluster 3 are recoded into Profit group 3.";

data tree_out;
	set tree_out;
	if Cluster = 2 then ProfitGroup = 1;
		else if Cluster = 1 then ProfitGroup = 2;
			else ProfitGroup = 3;
run;

proc freq data = tree_out;
	tables cluster * Profitgroup / norow nocol nopercent;
run;

proc glm data = tree_out;
	class ProfitGroup;
	model profit = ProfitGroup;
	ods select boxplot;
run;

proc genmod data = tree_out;
	class Profitgroup;
	model Profitgroup = EngineSize Horsepower MPG_City MPG_Highway Weight Length Wheelbase / Dist = Multinomial link = CUMLOGIT Type3 ;
	ods select ModelInfo ParameterEstimates Type3;
run;

ods text = "SAS returned ridiculously large/small standard errors. Therefore, I conclude (quasi-)complete separation occurred, indicating (almost) perfect classification occurred.";



/* Part 3: Statistical Model Construction to Predict Expected Profit*/
ods text = "Part 3: Statistical Model Construction to Predict Expected Profit";
ods text = "I identified 13 explanantory variables (Type, Origin, DriveTrain, MSRP, Invoice, EngineSize, Cylinders, Horsepower, MPG_City, MPG_Highway, Weight, Wheelbase, and Length).
Before conducting any analysis, we know that MSRP and Invoice cannot be in the model at the same time. The first step to construct a linear regression model is to construct 13 main-effect-only models, each with one explanatory variable, and eliminate those not significant.";

proc glm data = cars;
	class type;
	model profit = type ;
	ods select  ModelAnova FitStatistics;
run; ods text = "Variable 'Type' is significant at the .0001 level. However, its R-square is only .1713. Therefore, it will be eliminated.";

proc glm data = cars;
	class origin;
	model profit = origin;
	ods select ModelAnova FitStatistics;
run; ods text = "Variable 'Origin' is significant at the .0001 level. However, its R-square is only .1618. Therefore, it will be eliminated.";


proc glm data = cars;
	class DriveTrain;
	model profit = DriveTrain;
	ods select ModelAnova FitStatistics;
run; ods text = "Variable 'DriveTrain' is significant at the .0001 level. However, its R-square is only .2062. Therefore, it will be eliminated.";

proc reg data = cars;
	model profit = MSRP;
	ods select ANOVA FitStatistics;
run; ods text = "Variable 'MSRP' will not be eliminated in next step.";


proc reg data = cars;
	model profit = Invoice;
	ods select ANOVA FitStatistics;
run; ods text = "Variable 'Invoice' is significant. However, because it cannot be in the model along with MSRP, and it has a smaller F statistic, it will be eliminated. ";

proc reg data = cars;
	model profit = EngineSize;
	ods select ANOVA FitStatistics;
run; ods text = "Variable 'EngineSize' will not be eliminated in next step.";


proc glm data = cars;
	model profit = Cylinders;
	ods select ModelANOVA FitStatistics;
run; ods text = "Variable 'Cylinders' will not be eliminated in next step.";


proc reg data = cars;
	model profit = HorsePower;
	ods select ANOVA FitStatistics;
run; ods text = "Variable 'HorsePower' will not be eliminated in next step.";


proc reg data = cars;
	model profit = MPG_City;
	ods select ANOVA FitStatistics;
run; ods text = "Variable 'MPG_City' will not be eliminated in next step.";


proc reg data = cars;
	model profit = MPG_Highway;
	ods select ANOVA FitStatistics;
run; ods text = "Variable 'MPG_Highway' will not be eliminated in next step.";


proc reg data = cars;
	model profit = Weight;
	ods select ANOVA FitStatistics;
run; ods text = "Variable 'Weight' will not be eliminated in next step.";


proc reg data = cars;
	model profit = WheelBase;
	ods select ANOVA FitStatistics;
run; ods text = "Variable 'WheelBase' is significant at the .0005 level. However, it's R-square is merely 0.03. Therefore, it will be eliminated in next step.";

proc reg data = cars;
	model profit = length;
	ods select ANOVA FitStatistics;
run; ods text = "Variable 'Length' is significant at the .0001 level. However, it's R-square is merely 0.04. Therefore, it will be eliminated in next step.";


ods text = "In the next step, I will put all explanatory variables that were not previously eliminated into a linear model, and have SAS perform forward selection.";

proc reg data = cars;
	model profit = MSRP EngineSize Cylinders Horsepower MPG_City MPG_Highway Weight / selection = forward sle = .05;
	ods select ParameterEstimates DiagnosticsPanel;
run;

ods text = "Diagnostics panel indicates violation of Normality assumption and Constant Variance assumption. ";
ods text = "Therefore, I will transform Profit by taking its natural logarithm, and refit the model. ";

proc sgplot data = cars;
	scatter x = msrp y = invoice;
run;
ods text = "Note that after transforming Profit, there is no longer perfect linear relationship among MSRP, Invoice, and sqrt(profit). However, it is found that MSRP and Invoice are highly correlated. Therefore, I will only keep MSRP in the model";


proc reg data = cars;
	model logprofit = MSRP EngineSize Cylinders Horsepower MPG_City MPG_highway Weight Wheelbase Length
/ selection = forward sle = .05;
*	ods select ParameterEstimates DiagnosticsPanel;
run;

ods text = "Selection process picks out MSRP, Weight, and Horsepower";
ods text = "Residual plot shows several observations have exceptionally large residual. I will find out which they are.";
proc reg data = cars noprint;
	model logprofit = MSRP  Weight Horsepower;
	output out = regresult residual = residual;
run;

data regresult;
	set regresult;
	residualabs = abs(residual);
run;

proc sort data = regresult;
	by descending residualabs;
run;

title "Top 10 Vehicles with Largest Residuals";
proc print data = regresult (firstobs = 1 obs = 10);
	var Make Model MSRP Invoice Residual Residualabs;
run;
title;

ods text = "It turns out the 9 outlying residuals are from Suzuki vehicles and a Porsche. I will remove these 9 vehicles from analysis.";

proc reg data = regresult;
	where residualabs < 1;
	model logprofit = MSRP Weight Horsepower;
run;

ods text = "Residual plots show no strong indication of violation of equal variance assumption. q-q plot also shows no strong indication of violation of normality assumption. There is one observation, however, with exceptionally large Cook's DIstance. I will try to remove this point from our model.";

proc reg data = regresult noprint;
	where residualabs < 1;
	model logprofit = MSRP Weight Horsepower;
	output out = regresult_cookd cookd = cookd;
run;

proc sort data = regresult_cookd;
	by desending cookd;
run;

proc print data = regresult_cookd (firstobs = 1 obs = 5);
	var Make Model Cookd;
run;

proc reg data = regresult_cookd;
	where cookd < .1;
	model logprofit = MSRP Weight Horsepower;
	output out = regresult_cookd cookd = cookd;
	ods select diagnosticspanel;
run;
	
proc reg data = regresult_cookd;
	where cookd2 < .1;
	model logprofit = MSRP Weight Horsepower;	
	output out = regresult_cookd cookd = cookd;
	ods select diagnosticspanel;
run;

proc reg data = regresult_cookd;
	where cookd3 < .1;
	model logprofit = MSRP Weight Horsepower;	
	output out = regresult_cookd cookd = cookd;
	ods select diagnosticspanel;
run;

proc reg data = regresult_cookd;
	where cookd4 < .1;
	model logprofit = MSRP Weight Horsepower;	
	ods select ANOVA FitStatistics ParameterEstimates DiagnosticsPanel;
run;

ods text = "This is the final model. Interpretation in the body of the report is based on this model.";


ods text = "Note that we excluded Suzuki from linear regression. Now I am going to compare profit of cars made by Suzuki, and all other cars.";

title "Expected Profit: Suzuki or All Others";

proc glm data = cars;
	class Suzuki;
	model profit = Suzuki;
run;
title;

ods text = "Result shows that Suzuki cars have significanly less expected profit than other cars.";

	


/* Part 4: Determination, based on other variables, whether a model of vehicle is domestic or an import (Logistic Regression)*/ 
ods text = "Part 4: Determination, based on other variables, whether a model of vehicle is domestic or an import (Logistic Regression)";
ods text = "In this part, I will develop a logistic regression model, and predict whether a certain model of vehicle is domestic or an import.";
ods text = "To conduct such an analysis, I re-coded the variable Origin into Domestic if its value is 'USA', and Foreign if otherwise.";

*Note that probability modeled is Domestic;

proc logistic data = cars;
	class type DriveTrain / param = ref; 
	model DorF = Type DriveTrain EngineSize Cylinders Horsepower MPG_Highway MPG_City Weight Wheelbase Length ;
	ods select ResponseProfile ParameterEstimates ;
run;

ods text = "Based on the initial result, I will remove several variables, one at a time, and refit the model until all terms are significant.";

proc logistic data = cars;
	class  DriveTrain / param = ref; 
	model DorF = DriveTrain EngineSize Cylinders Horsepower MPG_Highway  MPG_City Weight Wheelbase Length ;
	ods select  ParameterEstimates; 
run;
ods text = "Variable 'Type' is removed in this step.";
 
proc logistic data = cars;
	class  DriveTrain / param = ref; 
	model DorF = DriveTrain EngineSize Cylinders Horsepower MPG_Highway  MPG_City Weight Wheelbase  ;
	ods select  ParameterEstimates; 
run;
ods text = "Variable 'Length' is removed in this step.";


proc logistic data = cars;
	model DorF =  EngineSize Cylinders Horsepower MPG_Highway  MPG_City Weight Wheelbase / LackFit ;
	ods select ResponseProfile OddsRatios ParameterEstimates 
		GlobalTests ModelInfo FitStatistics LackFitChiSq ;
run;
ods text = "Variable 'DriveTrain' is removed in this step. This is the final model, based on which the result is reported to the client.";
ods text = "Global test statistics all show our model is significantly better than an intercept-only model. In addition, Hosmer-Lemeshow test does not provide strong evidence for lack of fit. In addition, each term in the model is significant at least or almost at .01 level. Therefore, I conclude this model is a good fit.";


ods text = "This model shows that the odd of a car being domestic is associated with the following contributing factors: bigger engine size, better MPG on high way, and longer wheelbase.";
ods text = "This model also shows that the odd of a car being domestic is associated with the following undermining factors: less cylinders, less horsepower, lower MPG in the city, and lighter weight.";

ods text = "Now I will produce a classification table to show how good our model predicts the origin of a car.";

proc logistic data = cars noprint;
	model DorF =  EngineSize Cylinders Horsepower MPG_Highway  MPG_City Weight Wheelbase ;
	output out = logisticout predprobs = individual;
run;
/*
proc print data = logisticout;run;
*/
data logisticout;
	set logisticout;
	if IP_Domestic > .5 then DorFpredicted = "Domestic"; Else DorFpredicted = "Foreign";
run;



proc freq data = logisticout;
	tables DorF   *  DorFpredicted  / nocol nopercent  chisq;
run;

ods text = "The classification table shows that the model classifies Foreign vehicles correctly at a high success rate of 90%, and classifies Domestic vehicles correctly at a success rate of 67%.  Chi-square test statistics also show that the predicted Domestic-Or-Foreign is strongly associated with Actually Domestic-or-Foreign";





/* Part 5: Determination, based on other variables, on the number of cylinders a vehicle has (cluster analysis)*/ 
ods text = "Part 5: Determination, based on other variables, on the number of cylinders a vehicle has";
ods text = "In the dataset provided by the client, all vehicles have 4, 6, or 8 cylinders. The number of cylinders a vehicle has is an important matrix that an auto dealer uses to structure inventory. In this part, I will design a model that could potentially help us to classify a vehicle based on information from other variables.";
ods text = "I will have SAS conduct discriminant analysis."; 



proc stepdisc data = cars sle = .05 sls = .05;
	class cylinders;
	var MSRP Invoice Enginesize Horsepower MPG_City MPG_Highway Length Weight Wheelbase ;
	ods select Summary;
run;

ods text = "First, I had SAS select variables for further discriminant analysis. I will use only these variables for further exploration.";
ods text = "I will use proportional-priors in analysis.";
proc discrim data = cars pool = test MANOVA crosslisterr;
	where cylinders = 4 or cylinders =  6 or cylinders =  8;
	class cylinders;
	var MPG_City MPG_Highway Invoice Enginesize;
	priors proportional;
	ods select ChiSq Multstat  ClassifiedCrossVal ErrorCrossVal PostCrossVal ;
run;

ods text = "Multivariate statistics returned results significant at the .0001 level, indicating strong evidence to support differences among multivariate means.";
ods text = "Chi-square statistic returned significant result, indicating strong evidence of different covariances between cars of different Cylinder. We conclude there are differences in covariances. Therefore, within covariance matrices are used in analysis";
ods text = "Result shows our model achieves very high success rate when classifying vehicles based on the number of cylinders.";
ods text = "Result is reported in the body of the project.";


ods rtf close;
